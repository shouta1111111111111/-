<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>忍術バトル 究極統合版(Ver.12)</title><style>
body{font-family:sans-serif;text-align:center;background:#1a1a1a;color:#fff;margin:0;overflow:hidden;height:100vh;display:flex;flex-direction:column}
#menu-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.btn-group{display:flex;flex-direction:column;gap:12px;margin-bottom:25px}
.mode-btn{width:280px;padding:18px;font-size:1rem;background:#444;color:#fff;border:2px solid #666;border-radius:10px;cursor:pointer;font-weight:700;line-height:1.4}
.mode-btn.selected{background:#e74c3c;border-color:#fff;box-shadow:0 0 15px #e74c3c}
.start-btn{width:220px;padding:15px;background:#27ae60;color:#fff;border:none;border-radius:30px;font-size:1.3rem;font-weight:700;cursor:pointer;box-shadow:0 4px 0 #1e8449}
.player-area{height:40%;display:flex;flex-direction:column;justify-content:center;padding:10px;transition:opacity .3s;position:relative}
#p2-area{transform:rotate(180deg);border-bottom:2px solid #444}#p1-area{border-top:2px solid #444}
.hand{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;padding:10px}
.card{width:62px;height:85px;border:3px solid #fff;border-radius:8px;cursor:pointer;transition:0.2s;overflow:hidden;position:relative}
.card[data-type="火"]{background:#d32f2f}.card[data-type="水"]{background:#1976d2}.card[data-type="土"]{background:#f57c00}.card[data-type="風"]{background:#388e3c}.card[data-type="雷"]{background:#fbc02d}
.card.selected{transform:translateY(-15px);border-color:#f1c40f;box-shadow:0 0 15px #f1c40f}
.card img{width:100%;height:70%;object-fit:cover;pointer-events:none}
.card-label{font-size:12px;font-weight:700;background:rgba(0,0,0,0.6);position:absolute;bottom:0;width:100%}
#battle-center{height:20%;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;border-top:1px solid #555;border-bottom:1px solid #555;z-index:10}
#rule-banner{background:#e74c3c;color:#fff;font-size:0.8rem;padding:2px 12px;border-radius:10px;margin-bottom:5px;font-weight:bold}
.decide-btn{width:180px;height:50px;font-size:1.3rem;border-radius:25px;border:none;background:#e74c3c;color:#fff;font-weight:700;box-shadow:0 4px 0 #c0392b;cursor:pointer;margin:5px auto;touch-action:manipulation}
.waiting{opacity:.1;pointer-events:none}
#flash-div{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;pointer-events:none}
@keyframes flash{0%{opacity:0}50%{background:#fff;opacity:0.8}100%{opacity:0}}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100}
</style></head><body>
<div id="menu-screen">
    <h2 style="margin:0 0 10px 0">ルール選択</h2>
    <div class="btn-group">
        <button id="m-norm" class="mode-btn selected" onclick="selMode('N')">ノーマル<br><small>(最大3戦/出し直しOK)</small></button>
        <button id="m-adv" class="mode-btn" onclick="selMode('A')">アドバンス<br><small>(最大5戦/同一手禁止あり)</small></button>
    </div>
    <h2 style="margin:10px 0">対戦モード</h2>
    <div class="btn-group">
        <button id="p-com" class="mode-btn selected" onclick="selPlay('C')">1人 (vs COM)</button>
        <button id="p-pvp" class="mode-btn" onclick="selPlay('P')">2人 (対面バトル)</button>
    </div>
    <button class="start-btn" onclick="applyStart()">修行開始！</button>
</div>
<div id="flash-div"></div>
<div id="p2-area" class="player-area"><div id="p2-hand" class="hand"></div><button id="p2-btn" class="decide-btn" onclick="confirmMove(2)">決定</button></div>
<div id="battle-center">
    <div id="rule-banner"></div>
    <div id="status-msg">いざ、尋常に…</div>
    <div id="score-line">P1: 0 | P2: 0</div>
    <div id="last-moves"></div>
</div>
<div id="p1-area" class="player-area"><button id="p1-btn" class="decide-btn" onclick="confirmMove(1)">決定</button><div id="p1-hand" class="hand"></div></div>
<div id="overlay" class="modal"><h2>交代してください</h2><button class="mode-btn" onclick="closeOverlay()">準備完了</button></div>

<script>
const icons={'火':'https://livedoor.blogimg.jp/pokeruto_narutostorm/imgs/9/d/9df794cc.png','水':'https://ooyake01.com/wp-content/uploads/2019/07/%E6%89%89%E9%96%93.png','土':'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgUZKzoGoqlDT7mUC9X8fE76pwS8yTZOsQJWSf0JLyzQ&s=10','風':'https://otakotaku.com/asset/img/character/2017/10/uzumaki-naruto-59dbafb3a0d9ep.jpg','雷':'https://images-na.ssl-images-amazon.com/images/I/71rse6gO0XL._CR550,250,1420,1420_.jpg'},rel={'火':'風','風':'雷','雷':'土','土':'水','水':'火'},typeOrd={'火':1,'水':2,'土':3,'風':4,'雷':5};
let hands,scores,selected,confirmed,turn,gMode='N',pMode='C',p1D=[],p2D=[],firstPt=null,bannedStr=null;

// モード選択
function selMode(m){
    gMode=m; bannedStr=null; // 切り替え時に禁止手をリセット
    document.getElementById('m-norm').className=m==='N'?'mode-btn selected':'mode-btn';
    document.getElementById('m-adv').className=m==='A'?'mode-btn selected':'mode-btn';
}
function selPlay(p){
    pMode=p;
    document.getElementById('p-com').className=p==='C'?'mode-btn selected':'mode-btn';
    document.getElementById('p-pvp').className=p==='P'?'mode-btn selected':'mode-btn';
}

function applyStart(){
    document.getElementById('menu-screen').style.display='none';
    initGame();
}

function initGame(){
    hands={1:['火','水','土','風','雷'],2:['火','水','土','風','雷']};
    scores={1:0,2:0}; selected={1:[],2:[]}; confirmed={1:!1,2:!1};
    turn=1; firstPt=null; bannedStr=null; p1D=[]; p2D=[];
    document.getElementById('p2-btn').style.visibility=(pMode==='C')?'hidden':'visible';
    document.getElementById('rule-banner').innerText = (gMode==='N') ? "【ノーマル：出し直しOK】" : "【アドバンス：1戦目あいこで禁止】";
    renderHands(); unlockArea(1); unlockArea(2);
}

function renderHands(){
    for(let p=1;p<=2;p++){
        const t=document.getElementById(`p${p}-hand`); t.innerHTML="";
        if(pMode==='C'&&p===2){
            hands[p].forEach(()=>{const e=document.createElement("div");e.className="card";e.style.background="#555";t.appendChild(e);});
        }else{
            hands[p].forEach(n=>{
                const isSel=selected[p].includes(n),o=document.createElement("div");
                o.className=`card ${isSel?"selected":""}`; o.dataset.type=n;
                o.innerHTML=`<img src="${icons[n]}"><div class="card-label">${n}</div>`;
                o.onclick=()=>{if(!confirmed[p]){isSel?selected[p]=selected[p].filter(x=>x!==n):selected[p].push(n);renderHands();}};
                t.appendChild(o);
            });
        }
    }
    const limit=(gMode==='N')?3:5;
    document.getElementById('score-line').innerText=`P1: ${scores[1]} | P2: ${scores[2]} (戦目:${turn}/${limit})`;
}

// 決定ボタン押下時の処理
function confirmMove(p){
    const s = selected[p].slice().sort((a,b)=>typeOrd[a]-typeOrd[b]);
    const cur = s.join("+");
    
    if(s.length===0) return;

    // 【重要】ノーマルモードなら何があっても禁止チェックをスルーする
    if(gMode === 'N'){
        bannedStr = null; 
    } else {
        // アドバンスモードの場合のみ、直前と同じ手かをチェック
        if(bannedStr && cur === bannedStr){
            alert("アドバンスルール：直前と同じ出し方はできません！");
            return;
        }
    }

    // 忍術合成バリデーション
    if(s.length===2 && !(s.includes('水') && s.includes('風'))){ alert("2枚は氷遁(水+風)のみ！"); return; }
    if(s.length===3 && !(s.includes('火') && s.includes('風') && s.includes('土'))){ alert("3枚は塵遁(火+風+土)のみ！"); return; }

    if(p===1) p1D=[...s]; else p2D=[...s];
    confirmed[p]=!0; selected[p]=[]; renderHands(); lockArea(p);

    if(confirmed[1]){
        if(pMode==='C') setTimeout(comLogic, 500);
        else if(confirmed[2]) battle();
        else showOverlay();
    }
}

function comLogic(){
    const h2=hands[2]; let possible=[];
    h2.forEach(c=>possible.push([c]));
    if(h2.includes('水')&&h2.includes('風')) possible.push(['水','風']);
    if(h2.includes('火')&&h2.includes('風')&&h2.includes('土')) possible.push(['火','風','土']);
    
    if(gMode==='A' && bannedStr){
        possible = possible.filter(p=>p.sort((a,b)=>typeOrd[a]-typeOrd[b]).join("+") !== bannedStr);
    }
    p2D = possible[Math.floor(Math.random()*possible.length)];
    confirmed[2]=!0; battle();
}

function battle(){
    const m1=p1D.sort((a,b)=>typeOrd[a]-typeOrd[b]), m2=p2D.sort((a,b)=>typeOrd[a]-typeOrd[b]);
    const s1=m1.join("+"), s2=m2.join("+");
    let win=0;

    // 枚数判定
    if(m1.length > m2.length) win=1; 
    else if(m2.length > m1.length) win=2;
    else if(m1.length === 1){ // 1枚同士の属性判定
        if(rel[m1[0]]===m2[0]) win=1; else if(rel[m2[0]]===m1[0]) win=2;
    }

    // 演出
    const f=document.getElementById('flash-div'); f.style.animation='none'; setTimeout(()=>{f.style.animation='flash 0.4s'},10);
    const limit = (gMode==='N')?3:5;

    if(win!==0){
        // 決着がついた場合
        scores[win]++; if(firstPt===null) firstPt=win;
        m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1));
        m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1));
        document.getElementById('status-msg').innerText=`P${win}の勝利！`;
        bannedStr=null; turn++;
    } else {
        // あいこの場合
        const isSame = (s1 === s2);
        if(gMode === 'N'){
            if(isSame && turn < 3){
                bannedStr=null; // ノーマル：確実に禁止を解除
                document.getElementById('status-msg').innerText="同一手あいこ！(再選択可能)";
                resetTurn(); return; // そのまま次の選択へ
            } else {
                m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1));
                m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1));
                document.getElementById('status-msg').innerText="引き分け(カード消費)";
                bannedStr=null; turn++;
            }
        } else {
            // アドバンス
            if(isSame && turn===1){
                bannedStr = s1; // 1戦目あいこのみ禁止手をセット
                document.getElementById('status-msg').innerText="1戦目あいこ！(直前の手は禁止)";
                resetTurn(); return;
            } else {
                m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1));
                m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1));
                document.getElementById('status-msg').innerText="引き分け(カード消費)";
                bannedStr=null; turn++;
            }
        }
    }
    
    document.getElementById('last-moves').innerHTML=`P1:${s1} vs P2:${s2}`;
    renderHands();
    
    if(scores[1]>=2 || scores[2]>=2 || turn>limit || hands[1].length===0 || hands[2].length===0){
        setTimeout(judgeFinal, 800);
    } else {
        resetTurn();
    }
}

function resetTurn(){
    confirmed={1:!1, 2:!1}; p1D=[]; p2D=[]; selected={1:[], 2:[]};
    unlockArea(1); unlockArea(2); renderHands();
}

function judgeFinal(){
    let w=0;
    if(scores[1]!==scores[2]) w=(scores[1]>scores[2])?1:2;
    else if(hands[1].length!==hands[2].length) w=(hands[1].length>hands[2].length)?1:2;
    else w=firstPt||1;
    alert(`試合終了！勝者: プレイヤー${w}`);
    document.getElementById('menu-screen').style.display='flex';
}

function lockArea(p){ document.getElementById(`p${p}-area`).classList.add('waiting'); }
function unlockArea(p){ document.getElementById(`p${p}-area`).classList.remove('waiting'); }
function showOverlay(){ document.getElementById('overlay').style.display='flex'; }
function closeOverlay(){ document.getElementById('overlay').style.display='none'; }
</script></body></html>
